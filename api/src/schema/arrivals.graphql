extend type GatheringService {
  target: Int!
    @cypher(
      statement: "MATCH (this)-[:HAS*4]->(bacentas:Bacenta:Active) WITH DISTINCT bacentas RETURN SUM(bacentas.target)"
    )
}

extend type Stream {
  target: Int!
    @cypher(
      statement: "MATCH (this)-[:HAS*3]->(bacentas:Active:Bacenta) WITH DISTINCT bacentas RETURN SUM(bacentas.target)"
    )
}

extend type Council {
  target: Int!
    @cypher(
      statement: "MATCH (this)-[:HAS*2]->(bacentas:Active:Bacenta) WITH DISTINCT bacentas RETURN SUM(bacentas.target)"
    )
}

extend type Constituency {
  zone: BusZone! @relationship(type: "BUSSES_FROM", direction: OUT)
  target: Int!
    @cypher(
      statement: "MATCH (this)-[:HAS]->(bacentas:Bacenta:Active) WITH DISTINCT bacentas RETURN SUM(bacentas.target)"
    )
}

type SwellDate implements TimeGraphNode
  @auth(rules: [{ isAuthenticated: true }]) {
  id: ID!
    @cypher(
      statement: """
      MATCH (this)
      RETURN toString(this.date)
      """
    )
  date: Date
  swell: Boolean
    @cypher(
      statement: """
      MATCH (this)
      UNWIND labels(this) AS swellStatus
      WITH swellStatus WHERE swellStatus ='SwellDate'
      RETURN true
      """
    )
  bussingDate: [BussingRecord!]! @relationship(type: "BUSSED_ON", direction: IN)
}

extend type Member {
  isArrivalsAdminForCouncil: [Council!]!
    @relationship(type: "DOES_ARRIVALS_FOR", direction: OUT)
  isArrivalsAdminForConstituency: [Constituency!]!
    @relationship(type: "DOES_ARRIVALS_FOR", direction: OUT)
  isArrivalsAdminForStream: [Stream!]!
    @relationship(type: "DOES_ARRIVALS_FOR", direction: OUT)
  isArrivalsAdminForGatheringService: [GatheringService!]!
    @relationship(type: "DOES_ARRIVALS_FOR", direction: OUT)
  isArrivalsCounterForStream: [Stream!]!
    @relationship(type: "COUNTS_ARRIVALS_FOR", direction: OUT)
}
extend type GatheringService {
  arrivalsAdmin: Member @relationship(type: "DOES_ARRIVALS_FOR", direction: IN)
  bacentasNoActivity: [Bacenta!]!
    @cypher(
      statement: """
      MATCH (this)-[:HAS*4]->(bacentas:Active:Bacenta)
      WHERE NOT EXISTS {
        MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        }
      RETURN DISTINCT bacentas
      """
    )
  bacentasNoActivityCount: Int
    @cypher(
      statement: """
      MATCH (this)-[:HAS*4]->(bacentas:Active:Bacenta)
       WHERE NOT EXISTS {
         MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
         WHERE date(date.date)=date()
         }
      RETURN COUNT(DISTINCT bacentas)
      """
    )
  bacentasMobilising: [Bacenta!]!
    @cypher(
      statement: """
      MATCH (this)-[:HAS*4]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.mobilisationPicture IS NOT NULL
        AND bussing.leaderDeclaration IS NULL
      }
      RETURN DISTINCT bacentas
      """
    )
  bacentasMobilisingCount: Int
    @cypher(
      statement: """
      MATCH (this)-[:HAS*4]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.mobilisationPicture IS NOT NULL
        AND bussing.leaderDeclaration IS NULL
      }
      RETURN COUNT(DISTINCT bacentas)
      """
    )
  bacentasOnTheWay: [Bacenta!]!
    @cypher(
      statement: """
      MATCH (this)-[:HAS*4]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.leaderDeclaration IS NOT NULL
        AND bussing.arrivalTime IS NULL
      }
      RETURN DISTINCT bacentas
      """
    )
  bacentasOnTheWayCount: Int
    @cypher(
      statement: """
      MATCH (this)-[:HAS*4]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.leaderDeclaration IS NOT NULL
        AND bussing.arrivalTime IS NULL
      }
      RETURN COUNT(DISTINCT bacentas)
      """
    )
  bussingMembersOnTheWayCount: Int
    @cypher(
      statement: """
       MATCH (this)-[:HAS*4]->(bacentas:Active:Bacenta)
       MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.leaderDeclaration IS NOT NULL
        AND bussing.arrivalTime IS NULL

      WITH DISTINCT bussing
      RETURN SUM(bussing.attendance)
      """
    )
  bacentasHaveBeenCounted: [Bacenta!]!
    @cypher(
      statement: """
      MATCH (this)-[:HAS*4]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph) WHERE date(date.date)=date()
       AND EXISTS {MATCH (bussing)-[:COUNTED_BY]->(:Member)}
      }
      RETURN DISTINCT bacentas
      """
    )
  bacentasHaveBeenCountedCount: Int
    @cypher(
      statement: """
      MATCH (this)-[:HAS*4]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
       MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph) WHERE date(date.date)=date()
       AND EXISTS {MATCH (bussing)-[:COUNTED_BY]->(:Member)}
      }
      RETURN COUNT(DISTINCT bacentas)
      """
    )
  bacentasNotCounted: [Bacenta!]!
    @cypher(
      statement: """
      MATCH (this)-[:HAS*4]->(bacentas:Active:Bacenta)
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
      WHERE date(date.date)=date() AND bussing.leaderDeclaration IS NOT NULL
      AND NOT EXISTS {
       MATCH (bussing)-[:COUNTED_BY]->(:Member)
      }
      RETURN DISTINCT bacentas
      """
    )
  bacentasNotCountedCount: Int
    @cypher(
      statement: """
      MATCH (this)-[:HAS*4]->(bacentas:Active:Bacenta)
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
       WHERE date(date.date)=date() AND bussing.leaderDeclaration IS NOT NULL
      AND NOT EXISTS {
       MATCH (bussing)-[:COUNTED_BY]->(:Member)
      }
      RETURN COUNT(DISTINCT bacentas)
      """
    )
  bacentasBelow8: [Bacenta!]!
    @cypher(
      statement: """
      MATCH (this)-[:HAS*4]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.attendance < 8
      }
      RETURN DISTINCT bacentas
      """
    )
  bacentasBelow8Count: Int!
    @cypher(
      statement: """
      MATCH (this)-[:HAS*4]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.attendance < 8
      }
      RETURN COUNT(DISTINCT bacentas)
      """
    )
  bacentasHaveArrived: [Bacenta!]!
    @cypher(
      statement: """
      MATCH (this)-[:HAS*4]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.arrivalTime IS NOT NULL
      }
      RETURN DISTINCT bacentas
      """
    )
  bacentasHaveArrivedCount: Int
    @cypher(
      statement: """
      MATCH (this)-[:HAS*4]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.arrivalTime IS NOT NULL
      }
      RETURN COUNT(DISTINCT bacentas)
      """
    )
  bussingMembersHaveArrivedCount: Int
    @cypher(
      statement: """
       MATCH (this)-[:HAS*4]->(bacentas:Active:Bacenta)
       MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
         WHERE date(date.date)=date()
        AND bussing.arrivalTime IS NOT NULL

      WITH DISTINCT bussing
      RETURN SUM(bussing.attendance)
      """
    )
}

extend type Stream {
  arrivalsAdmin: Member @relationship(type: "DOES_ARRIVALS_FOR", direction: IN)
  arrivalsCounters: [Member!]!
    @relationship(type: "COUNTS_ARRIVALS_FOR", direction: IN)
  bacentasNoActivity: [Bacenta!]!
    @cypher(
      statement: """
      MATCH (this)-[:HAS*3]->(bacentas:Active:Bacenta)
      WHERE NOT EXISTS {
        MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        }
      RETURN DISTINCT bacentas
      """
    )
  bacentasNoActivityCount: Int
    @cypher(
      statement: """
      MATCH (this)-[:HAS*3]->(bacentas:Active:Bacenta)
       WHERE NOT EXISTS {
         MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
         WHERE date(date.date)=date()
         }
      RETURN COUNT(DISTINCT bacentas)
      """
    )
  bacentasMobilising: [Bacenta!]!
    @cypher(
      statement: """
      MATCH (this)-[:HAS*3]->(bacentas:Active:Bacenta)
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.mobilisationPicture IS NOT NULL
        AND NOT EXISTS {
        MATCH (bussing)-[:INCLUDES_RECORD]->(record:VehicleRecord)
        }
      RETURN DISTINCT bacentas
      """
    )
  bacentasMobilisingCount: Int
    @cypher(
      statement: """
      MATCH (this)-[:HAS*3]->(bacentas:Active:Bacenta)
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.mobilisationPicture IS NOT NULL
        AND NOT EXISTS {
        MATCH (bussing)-[:INCLUDES_RECORD]->(record:VehicleRecord)
        }
      RETURN COUNT(DISTINCT bacentas)
      """
    )
  bacentasOnTheWay: [Bacenta!]!
    @cypher(
      statement: """
       MATCH (this)-[:HAS*3]->(bacentas:Active:Bacenta)
       MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND EXISTS {
        MATCH (bussing)-[:INCLUDES_RECORD]->(record:VehicleRecord)
        WHERE record.arrivalTime IS NULL
        }
      RETURN DISTINCT bacentas
      """
    )
  bacentasOnTheWayCount: Int
    @cypher(
      statement: """
      MATCH (this)-[:HAS*3]->(bacentas:Active:Bacenta)
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
      WHERE date(date.date)=date()
      MATCH (bussing)-[:INCLUDES_RECORD]->(record:VehicleRecord)
      WHERE record.arrivalTime IS NULL

      RETURN COUNT(DISTINCT bacentas)
      """
    )
  bussingMembersOnTheWayCount: Int
    @cypher(
      statement: """
       MATCH (this)-[:HAS*3]->(bacentas:Active:Bacenta)
       MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        MATCH (bussing)-[:INCLUDES_RECORD]->(record:VehicleRecord)
        WHERE record.arrivalTime IS NULL

      WITH DISTINCT record
      RETURN SUM(record.attendance)
      """
    )
  bacentasHaveBeenCounted: [Bacenta!]!
    @cypher(
      statement: """
      MATCH (this)-[:HAS*3]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph) WHERE date(date.date)=date()
       AND EXISTS {MATCH (bussing)-[:COUNTED_BY]->(:Member)}
      }
      RETURN DISTINCT bacentas
      """
    )
  bacentasHaveBeenCountedCount: Int
    @cypher(
      statement: """
       MATCH (this)-[:HAS*3]->(bacentas:Active:Bacenta)
       WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph) WHERE date(date.date)=date()
        AND EXISTS {MATCH (bussing)-[:COUNTED_BY]->(:Member)}
       }
       RETURN COUNT(DISTINCT bacentas)
      """
    )
  bacentasNotCounted: [Bacenta!]!
    @cypher(
      statement: """
      MATCH (this)-[:HAS*3]->(bacentas:Active:Bacenta)
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
      WHERE date(date.date)=date()
      MATCH (bussing)-[:INCLUDES_RECORD]->(record:VehicleRecord)
      
      WHERE NOT EXISTS {
       MATCH (record)-[:COUNTED_BY]->(:Member)
      }
      RETURN DISTINCT bacentas
      """
    )
  bacentasNotCountedCount: Int
    @cypher(
      statement: """
      MATCH (this)-[:HAS*3]->(bacentas:Active:Bacenta)
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
      WHERE date(date.date)=date()
      MATCH (bussing)-[:INCLUDES_RECORD]->(record:VehicleRecord)
     
      WHERE NOT EXISTS {
       MATCH (record)-[:COUNTED_BY]->(:Member)
      }
      RETURN COUNT(DISTINCT record)
      """
    )
  bacentasBelow8: [Bacenta!]!
    @cypher(
      statement: """
      MATCH (this)-[:HAS*3]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.attendance < 8
      }
      RETURN DISTINCT bacentas
      """
    )
  bacentasBelow8Count: Int!
    @cypher(
      statement: """
      MATCH (this)-[:HAS*3]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.attendance < 8
      }
      RETURN COUNT(DISTINCT bacentas)
      """
    )
  bacentasHaveArrived: [Bacenta!]!
    @cypher(
      statement: """
      MATCH (this)-[:HAS*3]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.arrivalTime IS NOT NULL
      }
      RETURN DISTINCT bacentas
      """
    )
  bacentasHaveArrivedCount: Int
    @cypher(
      statement: """
      MATCH (this)-[:HAS*3]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.arrivalTime IS NOT NULL
      }
      RETURN COUNT(DISTINCT bacentas)
      """
    )
  bussingMembersHaveArrivedCount: Int
    @cypher(
      statement: """
       MATCH (this)-[:HAS*3]->(bacentas:Active:Bacenta)
       MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
         WHERE date(date.date)=date()
        AND bussing.arrivalTime IS NOT NULL

      WITH DISTINCT bussing
      RETURN SUM(bussing.attendance)
      """
    )
}

extend type Council {
  arrivalsAdmin: Member @relationship(type: "DOES_ARRIVALS_FOR", direction: IN)
  graduatedBacentas: [Bacenta!]!
  icBacentas: [Bacenta!]!
  bacentasNoActivity: [Bacenta!]!
    @cypher(
      statement: """
      MATCH (this)-[:HAS*2]->(bacentas:Active:Bacenta)
      WHERE NOT EXISTS {
        MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        }
      RETURN DISTINCT bacentas
      """
    )
  bacentasNoActivityCount: Int
    @cypher(
      statement: """
      MATCH (this)-[:HAS*2]->(bacentas:Active:Bacenta)
       WHERE NOT EXISTS {
         MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
         WHERE date(date.date)=date()
         }
      RETURN COUNT(DISTINCT bacentas)
      """
    )
  bacentasMobilising: [Bacenta!]!
    @cypher(
      statement: """
      MATCH (this)-[:HAS*2]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.mobilisationPicture IS NOT NULL
        AND bussing.leaderDeclaration IS NULL
      }
      RETURN DISTINCT bacentas
      """
    )
  bacentasMobilisingCount: Int
    @cypher(
      statement: """
      MATCH (this)-[:HAS*2]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.mobilisationPicture IS NOT NULL
        AND bussing.leaderDeclaration IS NULL
      }
      RETURN COUNT(DISTINCT bacentas)
      """
    )
  bacentasOnTheWay: [Bacenta!]!
    @cypher(
      statement: """
      MATCH (this)-[:HAS*2]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.leaderDeclaration IS NOT NULL
        AND bussing.arrivalTime IS NULL
      }
      RETURN DISTINCT bacentas
      """
    )
  bacentasOnTheWayCount: Int
    @cypher(
      statement: """
      MATCH (this)-[:HAS*2]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.leaderDeclaration IS NOT NULL
        AND bussing.arrivalTime IS NULL
      }
      RETURN COUNT(DISTINCT bacentas)
      """
    )
  bussingMembersOnTheWayCount: Int
    @cypher(
      statement: """
       MATCH (this)-[:HAS*2]->(bacentas:Active:Bacenta)
       MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.leaderDeclaration IS NOT NULL
        AND bussing.arrivalTime IS NULL

      WITH DISTINCT bussing
      RETURN SUM(bussing.attendance)
      """
    )
  bacentasHaveBeenCounted: [Bacenta!]!
    @cypher(
      statement: """
      MATCH (this)-[:HAS*2]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph) WHERE date(date.date)=date()
       AND EXISTS {MATCH (bussing)-[:COUNTED_BY]->(:Member)}
      }
      RETURN DISTINCT bacentas
      """
    )
  bacentasHaveBeenCountedCount: Int
    @cypher(
      statement: """
      MATCH (this)-[:HAS*2]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph) WHERE date(date.date)=date()
       AND EXISTS {MATCH (bussing)-[:COUNTED_BY]->(:Member)}
      }
      RETURN COUNT(DISTINCT bacentas)
      """
    )
  bacentasNotCounted: [Bacenta!]!
    @cypher(
      statement: """
      MATCH (this)-[:HAS*2]->(bacentas:Active:Bacenta)
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
      WHERE date(date.date)=date() AND bussing.leaderDeclaration IS NOT NULL
      AND NOT EXISTS {
        MATCH (bussing)-[:COUNTED_BY]->(:Member)
      }
      RETURN DISTINCT bacentas
      """
    )
  bacentasNotCountedCount: Int
    @cypher(
      statement: """
      MATCH (this)-[:HAS*2]->(bacentas:Active:Bacenta)
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
      WHERE date(date.date)=date() AND bussing.leaderDeclaration IS NOT NULL
      AND NOT EXISTS {
       MATCH (bussing)-[:COUNTED_BY]->(:Member)
      }
      RETURN COUNT(DISTINCT bacentas)
      """
    )
  bacentasBelow8: [Bacenta!]!
    @cypher(
      statement: """
      MATCH (this)-[:HAS*2]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.attendance < 8
      }
      RETURN DISTINCT bacentas
      """
    )
  bacentasBelow8Count: Int!
    @cypher(
      statement: """
      MATCH (this)-[:HAS*2]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.attendance < 8
      }
      RETURN COUNT(DISTINCT bacentas)
      """
    )
  bacentasHaveArrived: [Bacenta!]!
    @cypher(
      statement: """
      MATCH (this)-[:HAS*2]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.arrivalTime IS NOT NULL
      }
      RETURN DISTINCT bacentas
      """
    )
  bacentasHaveArrivedCount: Int
    @cypher(
      statement: """
      MATCH (this)-[:HAS*2]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.arrivalTime IS NOT NULL
      }
      RETURN COUNT(DISTINCT bacentas)
      """
    )
  bussingMembersHaveArrivedCount: Int
    @cypher(
      statement: """
       MATCH (this)-[:HAS*2]->(bacentas:Active:Bacenta)
       MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
         WHERE date(date.date)=date()
        AND bussing.arrivalTime IS NOT NULL

      WITH DISTINCT bussing
      RETURN SUM(bussing.attendance)
      """
    )
}

type BusZone {
  id: ID!
  number: Int!
  sprinterCost: Float!
  sprinterTopUp: Float!
  urvanCost: Float!
  urvanTopUp: Float!
  constituencies: [Constituency!]!
    @relationship(type: "BUSSES_FROM", direction: IN)
}

extend type Constituency {
  #Arrivals in the Constituency
  arrivalsAdmin: Member @relationship(type: "DOES_ARRIVALS_FOR", direction: IN)
  bacentasNoActivity: [Bacenta!]!
    @cypher(
      statement: """
      MATCH (this)-[:HAS]->(bacentas:Active:Bacenta)
      WHERE NOT EXISTS {
        MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        }
      RETURN DISTINCT bacentas
      """
    )
  bacentasNoActivityCount: Int
    @cypher(
      statement: """
      MATCH (this)-[:HAS]->(bacentas:Active:Bacenta)
       WHERE NOT EXISTS {
         MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
         WHERE date(date.date)=date()
         }
      RETURN COUNT(DISTINCT bacentas)
      """
    )
  bacentasMobilising: [Bacenta!]!
    @cypher(
      statement: """
      MATCH (this)-[:HAS]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.mobilisationPicture IS NOT NULL
        AND bussing.leaderDeclaration IS NULL
      }
      RETURN DISTINCT bacentas
      """
    )
  bacentasMobilisingCount: Int
    @cypher(
      statement: """
      MATCH (this)-[:HAS]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.mobilisationPicture IS NOT NULL
        AND bussing.leaderDeclaration IS NULL
      }
      RETURN COUNT(DISTINCT bacentas)
      """
    )
  bacentasOnTheWay: [Bacenta!]!
    @cypher(
      statement: """
      MATCH (this)-[:HAS]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.leaderDeclaration IS NOT NULL
        AND bussing.arrivalTime IS NULL
      }
      RETURN DISTINCT bacentas
      """
    )
  bacentasOnTheWayCount: Int
    @cypher(
      statement: """
      MATCH (this)-[:HAS]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.leaderDeclaration IS NOT NULL
        AND bussing.arrivalTime IS NULL
      }
      RETURN COUNT(DISTINCT bacentas)
      """
    )
  bussingMembersOnTheWayCount: Int
    @cypher(
      statement: """
       MATCH (this)-[:HAS]->(bacentas:Active:Bacenta)
       MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.leaderDeclaration IS NOT NULL
        AND bussing.arrivalTime IS NULL

      WITH DISTINCT bussing
      RETURN SUM(bussing.attendance)
      """
    )
  bacentasHaveBeenCounted: [Bacenta!]!
    @cypher(
      statement: """
      MATCH (this)-[:HAS]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph) WHERE date(date.date)=date()
       AND EXISTS {MATCH (bussing)-[:COUNTED_BY]->(:Member)}
      }
      RETURN DISTINCT bacentas
      """
    )
  bacentasHaveBeenCountedCount: Int
    @cypher(
      statement: """
      MATCH (this)-[:HAS]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph) WHERE date(date.date)=date()
       AND EXISTS {MATCH (bussing)-[:COUNTED_BY]->(:Member)}
      }
      RETURN COUNT(DISTINCT bacentas)
      """
    )
  bacentasNotCounted: [Bacenta!]!
    @cypher(
      statement: """
       MATCH (this)-[:HAS]->(bacentas:Active:Bacenta)
       MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
      WHERE date(date.date)=date() AND bussing.leaderDeclaration IS NOT NULL
       AND NOT EXISTS {
        MATCH (bussing)-[:COUNTED_BY]->(:Member)
       }
       RETURN DISTINCT bacentas
      """
    )
  bacentasNotCountedCount: Int
    @cypher(
      statement: """
       MATCH (this)-[:HAS]->(bacentas:Active:Bacenta)
       MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
      WHERE date(date.date)=date() AND bussing.leaderDeclaration IS NOT NULL
       AND NOT EXISTS {
         MATCH (bussing)-[:COUNTED_BY]->(:Member)
       }
       RETURN COUNT(DISTINCT bacentas)
      """
    )
  bacentasBelow8: [Bacenta!]!
    @cypher(
      statement: """
      MATCH (this)-[:HAS]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.attendance < 8
      }
      RETURN DISTINCT bacentas
      """
    )
  bacentasBelow8Count: Int!
    @cypher(
      statement: """
      MATCH (this)-[:HAS]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.attendance < 8
      }
      RETURN COUNT(DISTINCT bacentas)
      """
    )
  bacentasHaveArrived: [Bacenta!]!
    @cypher(
      statement: """
      MATCH (this)-[:HAS]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.arrivalTime IS NOT NULL
      }
      RETURN DISTINCT bacentas
      """
    )
  bacentasHaveArrivedCount: Int
    @cypher(
      statement: """
      MATCH (this)-[:HAS]->(bacentas:Active:Bacenta)
      WHERE EXISTS {
      MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
        WHERE date(date.date)=date()
        AND bussing.arrivalTime IS NOT NULL
      }
      RETURN COUNT(DISTINCT bacentas)
      """
    )
  bussingMembersHaveArrivedCount: Int
    @cypher(
      statement: """
       MATCH (this)-[:HAS]->(bacentas:Active:Bacenta)
       MATCH (bacentas)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
         WHERE date(date.date)=date()
        AND bussing.arrivalTime IS NOT NULL

      WITH DISTINCT bussing
      RETURN SUM(bussing.attendance)
      """
    )
}

extend type Bacenta {
  zone: BusZone!
    @cypher(
      statement: "MATCH (this)<-[:HAS]-(:Constituency)-[:BUSSES_FROM]->(zone:BusZone) RETURN zone"
    )
  graduationStatus: String!
    @cypher(
      statement: """
      MATCH (this)
      UNWIND labels(this) AS status
      WITH status WHERE status = 'Graduated' OR status = 'IC'
      RETURN status
      """
    )

  mobileNetwork: String
  momoNumber: String
  momoName: String

  #Arrivals Data
  arrivalsCodeOfTheDay: String!
    @cypher(
      statement: "MATCH (arrivals:ArrivalsCodeOfTheDay) RETURN arrivals.code"
    )
  bussing(limit: Int!): [BussingRecord!]!
    @cypher(
      statement: """
      MATCH (this)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
      RETURN bussing ORDER BY date.date DESC LIMIT $limit
      """
    )
  bussingThisWeek: BussingRecord
    @cypher(
      statement: """
      MATCH (this)-[:HAS_HISTORY]->(:ServiceLog)-[:HAS_BUSSING]->(bussing:BussingRecord)-[:BUSSED_ON]->(date:TimeGraph)
      WHERE date(date.date).week = date().week
      RETURN bussing ORDER BY date.date
      """
    )
}

type BussingRecord implements Record @auth(rules: [{ isAuthenticated: true }]) {
  id: ID!

  week: Int!
    @cypher(
      statement: """
      MATCH (this)-[:BUSSED_ON]->(date:TimeGraph)
      RETURN date(date.date).week
      """
    )
  # Mobilisation
  created_at: DateTime! #mobilisation time is the time the record was created
  serviceDate: TimeGraph! @relationship(type: "BUSSED_ON", direction: OUT)
  mobilisationPicture: String!
  created_by: Member! @relationship(type: "LOGGED_BY", direction: OUT)

  #On The Way
  attendance: Int
    @cypher(
      statement: "MATCH (this)-[:INCLUDES_RECORD]->(record:VehicleRecord) WHERE record.attendance IS NOT NULL RETURN SUM(record.attendance)"
    )
  leaderDeclaration: Int
    @cypher(
      statement: "MATCH (this)-[:INCLUDES_RECORD]->(record:VehicleRecord) WHERE record.leaderDeclaration IS NOT NULL RETURN SUM(record.leaderDeclaration)"
    )
  bussingPictures: [String!]!
    @cypher(
      statement: """
      MATCH (this)-[:INCLUDES_RECORD]->(record:VehicleRecord)
      WHERE record.picture IS NOT NULL
      RETURN collect(record.picture)
      """
    )
  numberOfBusses: Int #Legacy Property for before we started collecting Spinter/Urvan details
  personalContribution: Float
    @cypher(
      statement: "MATCH (this)-[:INCLUDES_RECORD]->(record:VehicleRecord) WHERE record.personalContribution IS NOT NULL RETURN SUM(record.personalContribution)"
    )
  numberOfSprinters: Int
    @cypher(
      statement: "MATCH (this)-[:INCLUDES_RECORD]->(record:VehicleRecord) WHERE record.vehicle = 'Sprinter' RETURN COUNT(DISTINCT record)"
    )
  numberOfUrvans: Int
    @cypher(
      statement: "MATCH (this)-[:INCLUDES_RECORD]->(record:VehicleRecord) WHERE record.vehicle = 'Urvan' RETURN COUNT(DISTINCT record)"
    )
  numberOfCars: Int
    @cypher(
      statement: "MATCH (this)-[:INCLUDES_RECORD]->(record:VehicleRecord) WHERE record.vehicle = 'Car' RETURN COUNT(DISTINCT record)"
    )
  bussingCost: Float
    @cypher(
      statement: "MATCH (this)-[:INCLUDES_RECORD]->(record:VehicleRecord) WHERE record.vehicleCost IS NOT NULL RETURN SUM(record.vehicleCost)"
    )
  bussingTopUp: Float
    @cypher(
      statement: "MATCH (this)-[:INCLUDES_RECORD]->(record:VehicleRecord) WHERE record.vehicleTopUp IS NOT NULL RETURN SUM(record.vehicleTopUp)"
    )

  #Money Things
  mobileNetwork: String
  momoNumber: String
  momoName: String

  counted_by: [Member!]!
    @cypher(
      statement: """
      MATCH (this)-[:INCLUDES_RECORD]->(record:VehicleRecord)-[:COUNTED_BY]->(member:Member)
      RETURN DISTINCT member
      """
    )

  vehicleRecords: [VehicleRecord!]!
    @relationship(type: "INCLUDES_RECORD", direction: OUT)
  serviceLog: ServiceLog! @relationship(type: "HAS_BUSSING", direction: IN)
}

type VehicleRecord {
  id: ID!
  created_by: Member! @relationship(type: "LOGGED_BY", direction: OUT)
  created_at: DateTime! #mobilisation time is the time the record was created
  leaderDeclaration: Int!
  attendance: Int
  picture: String!
  vehicle: String!
  personalContribution: Float!

  momoNumber: String
  momoName: String
  mobileNetwork: String
  vehicleTopUp: Float
  vehicleCost: Float!

  counted_by: Member @relationship(type: "COUNTED_BY", direction: OUT)

  #Arrived
  comments: String
  arrivalTime: DateTime
  transactionId: Int

  bussingRecord: BussingRecord!
    @relationship(type: "INCLUDES_RECORD", direction: IN)
}

extend type Mutation {
  #Arrivals Roles
  MakeConstituencyArrivalsAdmin(
    arrivalsAdminId: ID!
    constituencyId: ID!
    oldArrivalsAdminId: ID
  ): Member
  RemoveConstituencyArrivalsAdmin(
    arrivalsAdminId: ID!
    constituencyId: ID!
  ): Member!
  MakeCouncilArrivalsAdmin(
    arrivalsAdminId: ID!
    councilId: ID!
    oldArrivalsAdminId: ID
  ): Member!
  RemoveCouncilArrivalsAdmin(arrivalsAdminId: ID!, councilId: ID!): Member!
  MakeStreamArrivalsAdmin(
    arrivalsAdminId: ID!
    streamId: ID!
    oldArrivalsAdminId: ID
  ): Member!
  RemoveStreamArrivalsAdmin(arrivalsAdminId: ID!, streamId: ID!): Member!
  MakeGatheringServiceArrivalsAdmin(
    arrivalsAdminId: ID!
    gatheringServiceId: ID!
    oldArrivalsAdminId: ID
  ): Member!
  RemoveGatheringServiceArrivalsAdmin(
    arrivalsAdminId: ID!
    gatheringServiceId: ID!
  ): Member!

  MakeStreamArrivalsCounter(arrivalsCounterId: ID!, streamId: ID!): Member!
  RemoveStreamArrivalsCounter(arrivalsCounterId: ID!, streamId: ID!): Member

  ## GENERATE CODE OF THE DAY
  GenerateCodeOfTheDay: String!
    @auth(
      rules: [
        {
          roles: [
            "adminStream"
            "adminGatheringService"
            "arrivalsAdminGatheringService"
          ]
        }
      ]
    )
    @cypher(
      statement: """
      MATCH (arr:ArrivalsCodeOfTheDay)
      SET arr.code = apoc.text.random(5, 'A-Z0-9')
      RETURN arr.code
      """
    )
  SetCodeOfTheDay(code: String!): String!
    @auth(
      rules: [
        { roles: ["adminGatheringService", "arrivalsAdminGatheringService"] }
      ]
    )
    @cypher(
      statement: """
      MATCH (arr:ArrivalsCodeOfTheDay)
      SET arr.code = $code
      RETURN arr.code
      """
    )

  UpdateBacentaBussingDetails(bacentaId: ID!, target: Int!): Bacenta!
    @auth(
      rules: [
        {
          roles: [
            "adminGatheringService"
            "arrivalsAdminGatheringService"
            "adminStream"
            "arrivalsAdminStream"
          ]
        }
      ]
    )
    @cypher(
      statement: """
      MATCH (bacenta:Bacenta {id: $bacentaId})
      	SET bacenta.target = $target


      CREATE (log:HistoryLog {id:apoc.create.uuid()})
        SET log.timeStamp = datetime(),
        log.historyRecord = bacenta.name + ' Bussing Details were updated'

      WITH log,bacenta
      MATCH (admin:Member {auth_id: $auth.jwt.sub})

      MERGE (log)-[:LOGGED_BY]->(admin)
      MERGE (log)-[:RECORDED_ON]->(date)
      MERGE (bacenta)-[:HAS_HISTORY]->(log)

      RETURN bacenta
      """
    )

  UpdateBusPaymentDetails(
    bacentaId: ID!
    mobileNetwork: String!
    momoName: String!
    momoNumber: String!
  ): Bacenta!
    @auth(rules: [{ roles: ["leaderBacenta"] }])
    @cypher(
      statement: """
      MATCH (bacenta:Bacenta {id: $bacentaId})
      	SET bacenta.mobileNetwork = $mobileNetwork,
        bacenta.momoName = $momoName,
        bacenta.momoNumber = $momoNumber

      WITH bacenta
      CREATE (log:HistoryLog {id:apoc.create.uuid()})
        SET log.timeStamp = datetime(),
        log.historyRecord = bacenta.name + ' Bus Payment Details were updated'

      WITH log,bacenta
      MATCH (admin:Member {auth_id: $auth.jwt.sub})
      MERGE (date:TimeGraph {date:date()})
      MERGE (log)-[:LOGGED_BY]->(admin)
      MERGE (log)-[:RECORDED_ON]->(date)
      MERGE (bacenta)-[:HAS_HISTORY]->(log)

      RETURN bacenta
      """
    )

  UpdateConstituencyZone(constituencyId: ID!, zone: Int!): Constituency!
    @auth(
      rules: [
        {
          roles: [
            "adminGatheringService"
            "arrivalsAdminGatheringService"
            "adminStream"
            "arrivalsAdminStream"
          ]
        }
      ]
    )
    @cypher(
      statement: """
      OPTIONAL MATCH (constituency:Constituency {id: $constituencyId})-[r:BUSSES_FROM]->(:BusZone)
       MATCH (new:BusZone {number: $zone})
       DELETE r

       MERGE (constituency)-[:BUSSES_FROM]->(new)

       RETURN constituency
      """
    )

  MakeBacentaIC(bacentaId: ID!): Bacenta!
    @auth(
      rules: [
        {
          roles: [
            "adminGatheringService"
            "arrivalsAdminGatheringService"
            "adminStream"
            "arrivalsAdminStream"
            "adminCouncil"
            "arrivalsAdminCouncil"
            "adminConstituency"
            "arrivalsAdminConstituency"
          ]
        }
      ]
    )
    @cypher(
      statement: """
      MATCH (bacenta:Bacenta {id: $bacentaId})

      CREATE (log:HistoryLog {id:apoc.create.uuid()})
        SET log.timeStamp = datetime(),
        log.historyRecord = bacenta.name + ' was demoted to IC status'

      WITH log,bacenta
      MATCH (admin:Member {auth_id: $auth.jwt.sub})
      MERGE (date:TimeGraph {date:date()})
      MERGE (log)-[:LOGGED_BY]->(admin)
      MERGE (log)-[:RECORDED_ON]->(date)
      MERGE (bacenta)-[:HAS_HISTORY]->(log)

      SET bacenta:IC
      REMOVE bacenta:Graduated

      RETURN bacenta
      """
    )

  MakeBacentaGraduated(bacentaId: ID!): Bacenta!
    @auth(
      rules: [
        {
          roles: [
            "adminGatheringService"
            "arrivalsAdminGatheringService"
            "adminStream"
            "arrivalsAdminStream"
            "adminCouncil"
            "arrivalsAdminCouncil"
            "adminConstituency"
            "arrivalsAdminConstituency"
          ]
        }
      ]
    )
    @cypher(
      statement: """
      MATCH (bacenta:Bacenta {id: $bacentaId})

      CREATE (log:HistoryLog {id:apoc.create.uuid()})
        SET log.timeStamp = datetime(),
        log.historyRecord = bacenta.name + ' was promoted to Graduated status'

      WITH log,bacenta
      MATCH (admin:Member {auth_id: $auth.jwt.sub})
      MERGE (date:TimeGraph {date:date()})
      MERGE (log)-[:LOGGED_BY]->(admin)
      MERGE (log)-[:RECORDED_ON]->(date)
      MERGE (bacenta)-[:HAS_HISTORY]->(log)
      MERGE (bacenta)-[:HAS_HISTORY]->(log)

      SET bacenta:Graduated
      REMOVE bacenta:IC

      RETURN bacenta
      """
    )

  # TODO: Rewrite this as a resolver to prevent anyone from filling this who doesn't have momo details
  UploadMobilisationPicture(
    bacentaId: ID!
    serviceDate: String!
    mobilisationPicture: String!
  ): BussingRecord!

  #Bussing Records Entries
  RecordVehicleFromBacenta(
    bussingRecordId: ID!
    attendance: Int!
    vehicleCost: Float!
    personalContribution: Float!
    vehicle: String!
    picture: String!
    outbound: Boolean!
  ): VehicleRecord!
    @cypher(
      statement: """
      MATCH (bussingRecord:BussingRecord {id: $bussingRecordId})
      CREATE (vehicleRecord:VehicleRecord  {id: apoc.create.uuid()})
      MERGE (bussingRecord)-[:INCLUDES_RECORD]->(vehicleRecord)

        SET vehicleRecord.leaderDeclaration = $attendance,
        vehicleRecord.created_at = datetime(),
        vehicleRecord.vehicleCost = $vehicleCost,
        vehicleRecord.personalContribution = $personalContribution,
        vehicleRecord.vehicle = $vehicle,
        vehicleRecord.picture =  $picture,
        vehicleRecord.outbound = $outbound

       WITH vehicleRecord, bussingRecord
        MATCH (leader:Member {auth_id: $auth.jwt.sub})
        MERGE (vehicleRecord)-[:LOGGED_BY]->(leader)

      RETURN vehicleRecord
      """
    )

  SetVehicleSupport(vehicleRecordId: ID!): VehicleRecord!

  ConfirmVehicleByAdmin(
    vehicleRecordId: ID!
    attendance: Int!
    vehicle: String!
    comments: String
  ): VehicleRecord!
    @auth(rules: [{ roles: ["arrivalsCounterStream"] }])
    @cypher(
      statement: """
      MATCH (vehicleRecord:VehicleRecord {id: $vehicleRecordId}) WHERE vehicleRecord.arrivalTime  IS NULL
        SET vehicleRecord.attendance = $attendance,
        vehicleRecord.vehicle = $vehicle,
        vehicleRecord.comments = $comments

         WITH vehicleRecord
          MATCH (admin:Member {auth_id: $auth.jwt.sub})
          MERGE (vehicleRecord)-[:COUNTED_BY]->(admin)

      RETURN vehicleRecord
      """
    )
    @auth(
      rules: [
        {
          roles: [
            "adminStream"
            "arrivalsAdminStream"
            "adminGatheringService"
            "arrivalsAdminGatheringService"
          ]
        }
      ]
    )

  RecordArrivalTime(vehicleRecordId: ID!): VehicleRecord!
  SetSwellDate(date: String!): TimeGraph!
  SendVehicleSupport(vehicleRecordId: ID!, stream_name: String!): VehicleRecord!
}

extend type Mutation {
  SetStreamArrivalTimes(
    id: ID!
    mobilisationStartTime: String!
    mobilisationEndTime: String!
    arrivalStartTime: String!
    arrivalEndTime: String!
  ): Stream!
    @cypher(
      statement: """
      MATCH (stream:Stream {id: $id})
      SET stream.mobilisationStartTime = $mobilisationStartTime,
        stream.mobilisationEndTime = $mobilisationEndTime,
        stream.arrivalStartTime = $arrivalStartTime,
        stream.arrivalEndTime = $arrivalEndTime
      RETURN stream
      """
    )
    @auth(
      rules: [
        {
          roles: [
            "adminStream"
            "arrivalsAdminStream"
            "adminGatheringService"
            "arrivalsAdminGatheringService"
          ]
        }
      ]
    )
}

#SETTING AND ENDING TIME THINGS
extend type Stream {
  mobilisationStartTime: DateTime
  mobilisationEndTime: DateTime
  arrivalStartTime: DateTime
  arrivalEndTime: DateTime
}

extend type Mutation {
  SendMobileVerificationNumber(
    firstName: String!
    phoneNumber: String!
    otp: String!
  ): String!

  SetStreamArrivalTimes(
    id: ID!
    mobilisationStartTime: String!
    mobilisationEndTime: String!
    arrivalStartTime: String!
    arrivalEndTime: String!
  ): Stream!
    @cypher(
      statement: """
      MATCH (stream:Stream {id: $id})
      SET stream.mobilisationStartTime = $mobilisationStartTime,
        stream.mobilisationEndTime = $mobilisationEndTime,
        stream.arrivalStartTime = $arrivalStartTime,
        stream.arrivalEndTime = $arrivalEndTime
      RETURN stream
      """
    )
    @auth(
      rules: [
        {
          roles: [
            "adminStream"
            "arrivalsAdminStream"
            "adminGatheringService"
            "arrivalsAdminGatheringService"
          ]
        }
      ]
    )
}
